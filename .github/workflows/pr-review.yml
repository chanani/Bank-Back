name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic PyGithub

      - name: Run AI Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: |
          python - <<'EOF'
          import os
          import anthropic
          from github import Github

          g = Github(os.environ['GITHUB_TOKEN'])
          repo = g.get_repo(os.environ['REPO_NAME'])
          pr = repo.get_pull(int(os.environ['PR_NUMBER']))

          changed_files = []
          for file in pr.get_files():
              if file.filename.endswith(('.java', '.kt', '.xml', '.gradle')):
                  changed_files.append({
                      'filename': file.filename,
                      'patch': file.patch or '',
                      'status': file.status
                  })

          if not changed_files:
              print("ë¦¬ë·°í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
              exit(0)

          changes_text = ""
          for file_info in changed_files:
              changes_text += f"\níŒŒì¼: {file_info['filename']} ({file_info['status']})\n"
              changes_text += f"{file_info['patch']}\n"
              changes_text += "-" * 80 + "\n"

          client = anthropic.Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
          
          system_prompt = """ê²½í—˜ ë§Žì€ ì‹œë‹ˆì–´ ê°œë°œìžë¡œì„œ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•´ì¤˜.

          ë¦¬ë·° ì§€ì¹¨:
          1. ê°€ìž¥ ì¤‘ìš”í•œ ë¬¸ì œì ì´ë‚˜ ê°œì„ ì‚¬í•­ì—ë§Œ ì§‘ì¤‘í•´.
          2. ì „ì²´ ë³€ê²½ì‚¬í•­ì— ëŒ€í•œ í†µí•©ëœ ë¦¬ë·°ë¥¼ ì œê³µí•´.
          3. êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆì„ ì œì‹œí•´.
          4. ì‚¬ì†Œí•œ ìŠ¤íƒ€ì¼ ë¬¸ì œëŠ” ë¬´ì‹œí•´.
          5. ì‹¬ê°í•œ ë²„ê·¸, ì„±ëŠ¥ ë¬¸ì œ, ë³´ì•ˆ ì·¨ì•½ì ë§Œ ì–¸ê¸‰í•´.
          6. ì´ë¯¸ ê°œì„ ëœ ì‚¬í•­ì€ ê¸ì •ì ìœ¼ë¡œ ì–¸ê¸‰í•´.

          ë¦¬ë·° í˜•ì‹:
          - ê°œì„ ëœ ì‚¬í•­: [ê¸ì •ì  ì–¸ê¸‰]
          - ì£¼ìš” ì´ìŠˆ: [ë¬¸ì œì ê³¼ ê°œì„  ë°©ì•ˆ]
          - ì „ë°˜ì ì¸ ì˜ê²¬: [ìš”ì•½]

          Spring Bootì™€ Java ì½”ë“œë¥¼ ì¤‘ì ì ìœ¼ë¡œ ë¦¬ë·°í•´ì¤˜."""

          try:
              message = client.messages.create(
                  model="claude-sonnet-4-5-20250929",
                  max_tokens=2000,
                  system=system_prompt,
                  messages=[{
                      "role": "user",
                      "content": f"ë‹¤ìŒ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì¤˜:\n\n{changes_text}"
                  }]
              )

              review_text = message.content[0].text
              pr.create_issue_comment(f"## ðŸ¤– Claude AI ì½”ë“œ ë¦¬ë·°\n\n{review_text}")
              print("ë¦¬ë·° ì™„ë£Œ!")
          
          except Exception as e:
              print(f"ì—ëŸ¬ ë°œìƒ: {str(e)}")
              pr.create_issue_comment(f"## âš ï¸ AI ë¦¬ë·° ì‹¤íŒ¨\n\nì—ëŸ¬: {str(e)}")
              raise

          EOF